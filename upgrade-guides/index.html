<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.55">
<link rel="stylesheet" href="react-image-lightbox/style.css"><title data-react-helmet="true">Upgrade guides | Joern Documentation</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Upgrade guides | Joern Documentation"><meta data-react-helmet="true" name="description" content="1.1.1: OverflowDb Traversals"><meta data-react-helmet="true" property="og:description" content="1.1.1: OverflowDb Traversals"><meta data-react-helmet="true" property="og:url" content="https://joernio.github.io/upgrade-guides"><link data-react-helmet="true" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&amp;display=swap"><link data-react-helmet="true" rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"><link data-react-helmet="true" rel="shortcut icon" href="/img/website-icon.png"><link data-react-helmet="true" rel="canonical" href="https://joernio.github.io/upgrade-guides"><link rel="stylesheet" href="/styles.d76b5722.css">
<link rel="preload" href="/styles.63ef370e.js" as="script">
<link rel="preload" href="/runtime~main.a31b6222.js" as="script">
<link rel="preload" href="/main.a1a9c2ad.js" as="script">
<link rel="preload" href="/1.e1eda06e.js" as="script">
<link rel="preload" href="/39.4197c376.js" as="script">
<link rel="preload" href="/1be78505.cc91c0fc.js" as="script">
<link rel="preload" href="/ec1ed54d.6e92f1ec.js" as="script">
<link rel="preload" href="/46ffa1e5.525abfff.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):(e.matches,t("dark"))}()</script><div id="__docusaurus">
<div class="main-wrapper"><div id="docs" class="docPage_1jis"><div id="sidebar"><div class="docSidebarContainer_1kjN"><div align="center" id="logo"><a href="https://joern.io"><img width="40%" src="/img/logo.svg"></a></div><div class="sidebar_25T_"><div class="menu menu_1e9D"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/home">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/installation">Installation</a></li><li class="menu__list-item"><a class="menu__link" href="/quickstart">Quickstart</a></li><li class="menu__list-item"><a class="menu__link" href="/shell">Interactive Shell</a></li><li class="menu__list-item"><a class="menu__link" href="/interpreter">Interpreter</a></li><li class="menu__list-item"><a class="menu__link" href="/exporting">Exporting Graphs</a></li><li class="menu__list-item"><a class="menu__link" href="/server">Server</a></li><li class="menu__list-item"><a class="menu__link" href="/organizing-projects">Workspace</a></li><li class="menu__list-item"><a class="menu__link" href="/code-property-graph">Code Property Graph</a></li><li class="menu__list-item"><a class="menu__link" href="/traversal-basics">Traversal Basics</a></li><li class="menu__list-item"><a class="menu__link" href="/c-syntaxtree">Syntax-Tree Queries</a></li><li class="menu__list-item"><a class="menu__link" href="/extensions">Extending Joern</a></li><li class="menu__list-item"><a class="menu__link" href="/glossary">Glossary</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">CPGQL Reference</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cpgql/reference-card">Reference Card</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cpgql/node-type-steps">Node-Type Steps</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cpgql/filter-steps">Filter Steps</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cpgql/core-steps">Core Steps</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cpgql/repeat-steps">Repeat Steps</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cpgql/complex-steps">Complex Steps</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cpgql/execution-directives">Execution Directives</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cpgql/augmentation-directives">Augmentation Directives</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cpgql/help-directive">Help Directive</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cpgql/calls">Calls</a></li></ul></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" href="/upgrade-guides">Upgrade guides</a></li></ul></div></div></div></div><div id="content-wrapper"><header><nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav></header><div class="docPage_1jis"><main class="docMainContainer_3j_A"><div class="container padding-vert--lg"><div class="row"><div class="col docItemCol_2AGf"><div class="docItemContainer_1tAC"><article><header><h1 class="docTitle_cWlf">Upgrade guides</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="111-overflowdb-traversals"></a>1.1.1: OverflowDb Traversals<a aria-hidden="true" tabindex="-1" class="hash-link" href="#111-overflowdb-traversals" title="Direct link to heading">#</a></h2><p>This release introduces a major rearchitecture of the cpg query language (CPGQL). Most changes happened under the hood, however there are a few changes that are user facing. The migration should be straightforward, and in any case we&#x27;re here to help.</p><p>Background: CPGQL was previously based on the <a href="https://tinkerpop.apache.org/gremlin.html">Gremlin graph traversal language</a> (accessible via <code>.raw</code>), and is now based on <a href="https://github.com/ShiftLeftSecurity/overflowdb/blob/master/traversal/src/main/scala/overflowdb/traversal/Traversal.scala">OverflowDb Traversal</a>. The main drivers behind this change are: better performance, less complexity and fewer dependencies. OverflowDb Traversal is a Scala collection with additional graph steps, which means we now inherit many useful steps from the rich Scala standard collection library, where previously convertions between Traversal and Scala collections were needed.
At the same time, Traversal offers largely the same steps and semantics as its TinkerPop predecessor. </p><p>Here are the most important new parts - from our experience the swap of <code>filter</code> and <code>where</code> accounts for 90% of user-facing changes:</p><ol><li><p><code>filter(A =&gt; Boolean)</code>: just like any other Scala collection, filter now simply takes a predicate (it used to take a Traversal). </p></li><li><p><code>where(trav: Traversal[A] =&gt; Traversal[_])</code>: preserves elements if the provided traversal has at least one result. This is what filter used to be.
<em>Effectively, <code>filter</code> and <code>where</code> are swapped</em>. </p></li><li><p>RIP <code>filterOnEnd</code> - this is now simply <code>filter</code></p></li><li><p><code>repeat</code> now has a builder DSL to configure it&#x27;s behaviour, which is more specific and easier to understand than tinkerpop&#x27;s api, which relied on the order of modulators in the traversal.
For example, in tinkerpop <code>.emit.repeat(Traversal)</code> means &quot;emit everything&quot;, while <code>.repeat(Traversal).emit</code> means &quot;emit all but the first element&quot;.
In OverflowDb Traversal this behaviour is more explicit: <code>.repeat(Traversal)(_.emit)</code> and <code>.repeat(Traversal)(_.emitAllButFirst)</code>.</p></li></ol><p>Some more examples for the migration: </p><ul><li><code>.repeat(x).until(y)</code> -&gt; <code>.repeat(x)(_.until(y))</code></li><li><code>.emit.repeat(x)</code> -&gt; <code>.repeat(x)(_.emit)</code></li><li><code>.repeat(x).emit</code> -&gt; <code>.repeat(x)(_.emitAllButFirst)</code></li><li><code>.emit.repeat(x).times(2)</code> -&gt; <code>.repeat(x)(_.emit.times(2))</code></li></ul><ol start="5"><li><p><code>repeat</code> uses depth first search (DFS) by default and can be configured to use breadth first search (BFS) instead.
Tinkerpop has a long standing <a href="https://github.com/apache/tinkerpop/pull/838">issue</a> that it claims to use DFS but actually uses BFS, and also cannot be configured to use one or the other. </p></li><li><p><code>.start</code> step only exists for <code>Node</code> and <code>NewNode</code>, not for other collections any more. Instead, use the standard scala collection mechanism <code>.to(Traversal)</code>:</p></li></ol><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-java codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// still works - nothing changed:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">val someMethod </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cpg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head</span></div><div class="token-line" style="color:#393A34"><span class="token plain">someMethod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parameter </span><span class="token comment" style="color:#999988;font-style:italic">//Traversal[MethodParameterIn]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// using `.to(Traversal)` - standard scala collection mechanism</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">val methodList</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cpg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">l</span></div><div class="token-line" style="color:#393A34"><span class="token plain">methodList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Traversal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//Traversal[Method]</span></div></div></div></div></div><ol start="7"><li><code>.clone</code> doesn&#x27;t exist any more - note that Traversals typically have Iterator semantics, i.e. they are consumed during iteration:</li></ol><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-java codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">val source </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cpg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">identifier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">val sink </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cpg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">sink</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">reachableByFlows</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">l  </span><span class="token comment" style="color:#999988;font-style:italic">//contains flows (if any)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">sink</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">reachableByFlows</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">l  </span><span class="token comment" style="color:#999988;font-style:italic">//always empty - both source and sink Traversals have been consumed!</span></div></div></div></div></div><p>If you want to execute your traversals multiple times, simply define them as a function (<code>def</code>) rather than a value (<code>val</code>):</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-java codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">def source </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cpg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">identifier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">def sink </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cpg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">sink</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">reachableByFlows</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">l  </span><span class="token comment" style="color:#999988;font-style:italic">//contains flows (if any)</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">sink</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">reachableByFlows</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">l  </span><span class="token comment" style="color:#999988;font-style:italic">//same result: also contains flows (if any)</span></div></div></div></div></div><p>Please let us know if you need help with your migration, either by opening an issue or asking on <a href="https://gitter.im/joern-code-analyzer/community">gitter</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="bleeding-edge--power-users-only"></a>Bleeding edge / power users only:<a aria-hidden="true" tabindex="-1" class="hash-link" href="#bleeding-edge--power-users-only" title="Direct link to heading">#</a></h3><p>8) If you used the underlying tinkerpop api and OverflowDb types (e.g. via <code>.raw</code>), your scripts may be subject to additional changes, due to the removal of the Tinkerpop dependency and renames in OverflowDb types:</p><ul><li><code>Steps</code> -&gt; <code>Traversal</code></li><li><code>NodeSteps</code> -&gt; <code>Traversal</code></li><li><code>NewNodeSteps</code> -&gt; <code>Traversal</code></li><li><code>OdbGraph</code> -&gt; <code>Graph</code></li><li><code>OdbNode</code> -&gt; <code>NodeDb</code></li><li><code>OdbEdge</code> -&gt; <code>Edge</code></li><li><code>id2</code> -&gt; <code>id</code></li><li><code>graph2</code> -&gt; <code>graph</code></li><li><code>addEdge2</code> -&gt; <code>addEdge</code></li><li><code>setProperty2</code> -&gt; <code>setProperty</code></li><li><code>NodeKeysOdb</code> -&gt; <code>NodeKeys</code></li><li>all Tinkerpop types are gone: <code>Vertex</code>, <code>Edge</code>, <code>VertexProperty</code>, <code>ScalaGraph</code>, <code>GremlinScala</code>, ...</li></ul></div></article></div></div><div class="col col--3"><div class="tableOfContents_tVyB"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#111-overflowdb-traversals" class="table-of-contents__link">1.1.1: OverflowDb Traversals</a><ul><li><a href="#bleeding-edge--power-users-only" class="table-of-contents__link">Bleeding edge / power users only:</a></li></ul></li></ul></div></div></div></div></main></div></div><div id="right-spacer"></div></div></div></div>
<script src="/styles.63ef370e.js"></script>
<script src="/runtime~main.a31b6222.js"></script>
<script src="/main.a1a9c2ad.js"></script>
<script src="/1.e1eda06e.js"></script>
<script src="/39.4197c376.js"></script>
<script src="/1be78505.cc91c0fc.js"></script>
<script src="/ec1ed54d.6e92f1ec.js"></script>
<script src="/46ffa1e5.525abfff.js"></script>
</body>
</html>